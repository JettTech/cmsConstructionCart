<% include _layouts/header %>

<h1 class="page-title">My Cart</h1>
<br/>


<% if (typeof cart !== "undefined") %>
	<table class="alignMiddle">
		<tr>
			<th>Image</th>
			<th>Title</th>
			<th>Price</th>
			<th>Quantity</th>
			<th></th>
			<th>Subtotal</th>
		</tr>

		<% var total = 0 %>
		<% cart.forEach(function(product) { %>
		<% var subTotal = parseFloat(product.qty * product.price).toFixed(2) %>
		<% total += subTotal %>
		<tr>
			<td>
				<img width="100px" class="cartImages" src="<%= product.image %>" alt="Image of Product">
			</td>
			<td><%= product.title %></td>
			<td><%= product.price %></td>
			<td><%= product.qty %></td>
			<td></td>
			<td>
				<a href="/cart/update/<%= product.title %>/?action=add">| +</a>&nbsp;
				<a href="/cart/update/<%= product.title %>/?action=remove">| -</a>&nbsp;|
				<a href="/cart/update/<%= product.title %>/?action=clear">| Clear |</a>&nbsp;
			</td>
			<td>$<%= +subTitle %></td> <!-- add the "+" sign to ensure that the type is rednered as an Integer. -->
		</tr>>
		<% }); %>
		<tr>
			<td colspan="6" align="right"><strong>$<%= parseFloat(total).toFixed(2) %></strong></td>
		</tr>
		<tr>
			<td colspan="5" align="right">
				<a class="btn btn-danger cart-deletion" href="/cart/clear">Clear cart</a>
			</td>
			<td colspan="5" align="right">
				<a class="btn btn-primary buy-now" href="#">Buy now</a>
			</td>
		</tr>
	</table>
	
	<form class="payPal" action="https://www.sandbox.paypal.com/cgi-bin/webscr" method="post">
		<input type="hidden" name="cmd" value="_cart">
		<input type="hidden" name="upload" value="1">
		<input type="hidden" name="business" value="jultranet-facilitator@gmail.com">
		<% var num = 0; %>
		<% cart.forEach(function(p) { %>
			<% num++ %>			
			<input type="hidden" name="item_name_<%= num %>" value="<% product.title %>">
			<input type="hidden" name="amount_<%= num %>" value="<% product.price %>">
			<input type="hidden" name="quantity_<%= num %>" value="<%= product.qty %>">
		<% }); %>
		<input type="hidden" name="currency_code" value="USD">
		<input type="hidden" name="amount" value="<%= total %>">
		<input type="submit" value="PayPal">
	</form>

<% } else { %>
	<h3 class="text-center">Your cart is empty.</h3>
<% } %>

<script type="text/javascript">
	$(document).ready(function() {
	//"Buy Now "  functionality
	$(".buy-now").on("click", function(e) {
		e.preventDefault();
		$.get("/cart/buynow", function() {
			$("form.payPal input[type=image]").click();
			$(".ajaxbg").show();
		})
	});
</script>

<% include _layouts/footer %>